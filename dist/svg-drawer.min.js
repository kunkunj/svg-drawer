!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["svg-drawer"]={})}(this,(function(t){"use strict";const e="http://www.w3.org/2000/svg",i="L",s="M",o="Q";var n;!function(t){t.line="L",t.curve="Q",t.none="none"}(n||(n={}));const a=(t,e)=>{t.style.cursor="pointer",t.onclick=function(){"none"==e.status&&(e.activeComponet=t)}},d=(t,e=1)=>{function i(t){return null!=t&&(e<-1?t/Math.abs(e):e>1?t*e:t)}return t.reduce(((t,e)=>t+` ${e.type} ${i(e.x1)||""} ${i(e.y1)||""} ${i(e.x)} ${i(e.y)}`),"")},r=t=>{let e={};return e.x=t.reduce(((t,e)=>t>e.x?e.x:t),t[0].x),e.y=t.reduce(((t,e)=>t>e.y?e.y:t),t[0].y),e},l=(t,e)=>t.map((t=>(t.x=t.x-e.x,t.y=t.y-e.y,t.x1=t.x1-e.x,t.y1=t.y1-e.y,t))),h=t=>{t.onmousedown=()=>{console.log(t),g(t)},t.onmouseup=()=>{g(null)}},c=(t,i,s,o,n)=>{const a=(()=>{const t=document.createElementNS(e,"svg"),i=document.createElementNS(e,"defs");return i.id="defs",t.appendChild(i),t})();return a.setAttribute("style",`position: absolute;\n    transform-origin: 0 0;\n    width:${i*o}px;\n    height:${s*o}px;\n    user-select:none;\n    left: 0;\n    right: 0;\n    background: #fbf8f8;`),t.style.position="relative",t.style.overflow="hidden",t.style.width=i+"px",t.style.height=s+"px",t.style.border="1px solid #ccc",t.appendChild(a),function(t,e,i){let s,o,n,a,r,h,c=1;function p(e){e.wheelDelta>0?c+=.1:c=c>=.6?c-.1:.5,i.scale=c,t.style.transform=`scale(${c})`}function u(){i.isEdit=!1,r=!1}function v(t){"Control"!=t.key||h||(h=!0)}function f(t){"Control"==t.key&&(h=!1)}t.addEventListener("mousewheel",p),window.addEventListener("mouseup",u),t.onmousedown=function(t){n=t.clientX,a=t.clientY,i.isEdit||(i.isDrag=!0,s=t.offsetX*c,o=t.offsetY*c,r=!0)},window.addEventListener("keydown",v),window.addEventListener("keyup",f),t.onmouseup=u,t.onmousemove=function(p){var u;if(i.isEdit){let t={x:(n-p.clientX)/(null==i?void 0:i.scale),y:(a-p.clientY)/(null==i?void 0:i.scale)};if(n=p.clientX,a=p.clientY,i.idStore[i.activeComponet.dataset.id]){const e=i.idStore[i.activeComponet.dataset.id].point;"curve"==i.activeEidter.type&&(i.idStore[i.activeComponet.dataset.id].point[i.activeEidter.index].x1=i.activeEidter.x-t.x,i.idStore[i.activeComponet.dataset.id].point[i.activeEidter.index].y1=i.activeEidter.y-t.y),i.activeEidter.index!==e.length-1&&"point"==i.activeEidter.type&&(i.idStore[i.activeComponet.dataset.id].point[i.activeEidter.index].x=i.activeEidter.x-t.x,i.idStore[i.activeComponet.dataset.id].point[i.activeEidter.index].y=i.activeEidter.y-t.y);let s=i.idStore[i.activeComponet.dataset.id].point[i.activeEidter.index].x==i.idStore[i.activeComponet.dataset.id].point[0].x&&i.idStore[i.activeComponet.dataset.id].point[i.activeEidter.index].y==i.idStore[i.activeComponet.dataset.id].point[0].y;i.activeEidter.index==e.length-1&&s&&"point"==i.activeEidter.type&&(i.idStore[i.activeComponet.dataset.id].point[i.activeEidter.index].x=i.activeEidter.x-t.x,i.idStore[i.activeComponet.dataset.id].point[i.activeEidter.index].y=i.activeEidter.y-t.y,i.idStore[i.activeComponet.dataset.id].point[0].x=i.activeEidter.x-t.x,i.idStore[i.activeComponet.dataset.id].point[0].y=i.activeEidter.y-t.y),i.activeEidter.setPosition(i.activeEidter.x-t.x,i.activeEidter.y-t.y),console.log(i.idStore[i.activeComponet.dataset.id].point[i.activeEidter.index]),i.activeComponet.setAttribute("d",d(i.idStore[i.activeComponet.dataset.id].point))}}else if(r&&h&&"none"==i.status&&(t.style.left=p.clientX-e.getBoundingClientRect().left-s+"px",t.style.top=p.clientY-e.getBoundingClientRect().top-o+"px"),!h&&r&&S.com&&m&&(null===(u=S.com)||void 0===u?void 0:u.dataset.id)===(null==m?void 0:m.dataset.id)){i.isDrag=!0;let t={x:(n-p.clientX)/c,y:(a-p.clientY)/c};n=p.clientX,a=p.clientY,i.idStore[S.com.dataset.id].point=l(i.idStore[S.com.dataset.id].point,t),S.com.setAttribute("d",d(i.idStore[S.com.dataset.id].point))}}}(a,t,n),a};class p{constructor(t,i){this.index=-1,this.flag=!1,this.el=null,this.r=t.r||2,this.lineColor=t.lineColor||"#000",this.lineWeight=t.lineWeight||1,this.x=t.x||0,this.y=t.y||0,this.fill=t.fill||"transparent",this.el=document.createElementNS(e,"circle"),this.el.style.cursor="n-resize",this.el.onmousedown=t=>{i.isEdit=!0,i.activeEidter=this},this.el.onmouseup=t=>{i.isEdit=!1},this.draw("all")}draw(t){"all"!=t&&"p"!=t||(this.el.setAttribute("cx",this.x),this.el.setAttribute("cy",this.y)),"all"!=t&&"t"!=t||(this.el.setAttribute("stroke",this.lineColor),this.el.setAttribute("stroke-width",this.lineWeight),this.el.setAttribute("fill",this.fill)),"all"!=t&&"r"!=t||this.el.setAttribute("r",this.r)}setPosition(t,e){this.x=t,this.y=e,this.draw("p")}setTheme(t){this.lineColor=t.color||this.lineColor,this.lineWeight=t.weight||this.lineWeight,this.fill=t.fill||this.fill,this.draw("t")}setR(t){this.r=t,this.draw("r")}}const u=(t,i,s)=>{const o=document.createElementNS(e,"path");return o.setAttribute("stroke",t),o.setAttribute("stroke-width",i),o.setAttribute("fill",s),o.onmousedown=()=>{},o},v=function(t,e,i){let s=[];for(let e=0;e<t.length;e++){const i={};t[e].children&&t[e].children.length&&(i.children=v(t[e].children)),i.dataset=t[e].dataset,i.attributes={},i.tagName=t[e].tagName;for(let s=0;s<t[e].attributes.length;s++)i.attributes[t[e].attributes[s].name]=t[e].attributes[s].value;s.push(i)}return s};let m=null;const{CacheQueue:f,initCache:C,EnterCache:y,OutCache:x}=(()=>{let t=[];return{CacheQueue:t,initCache:e=>{t=new Array(e).map((()=>0))},EnterCache:e=>{t.pop(),t.unshift(e)},OutCache:()=>{t.shift(),t.push(0)}}})();let{setComponet:g,clickComponet:S}=(t=>{let e={};return{clickComponet:e,setComponet:function(t){e.com=t}}})();class w{get isDrag(){return this._isDrag}set isDrag(t){this._isDrag=t,t?this._removePoint():this._addPoint(this.activeComponet)}get activeComponet(){return this._ActiveComponet}set activeComponet(t){if("string"!=typeof t){const e=!!this.children.find((e=>e.dataset.id===t.dataset.id));e&&this._ActiveComponet&&(this._ActiveComponet.setAttribute("stroke",this._ActiveComponet.dataset.line),this._ActiveComponet=t,t.setAttribute("stroke",this.activeColor),m=t),e||(t.setAttribute("stroke",this.activeColor),this._ActiveComponet=t),this._addPoint(t)}else this._removePoint(),this._ActiveComponet.setAttribute("stroke",t)}constructor(t,e){if(this.scale=1,this.isEdit=!1,this.dev=!0,this.extremePoints=[],this.children=[],this.pointList=[],this.idStore={},this._isDrag=!1,this.activeColor="rgb(43 219 237)",!t||"object"!=typeof t||!t.tagName)throw new Error("You need to pass in a HTMLElement");this.width=(null==e?void 0:e.width)||500,this.height=(null==e?void 0:e.height)||500,this.cache=(null==e?void 0:e.cache)||5,this.multiple=(null==e?void 0:e.multiple)||2,this._DOM=t,this.status="none",this.init(),C(this.cache)}init(){this.canvas=c(this._DOM,this.width,this.height,this.multiple,this),this.group=document.getElementById("defs"),this.canvas.onclick=t=>{if("line"==this.status){let e=this.activeComponet.getAttribute("d"),o={x:t.offsetX,y:t.offsetY};e?(e+=` ${i} ${t.offsetX} ${t.offsetY}`,o.type=i):(e=`${s} ${t.offsetX} ${t.offsetY}`,o.type=s),this.idStore[this.activeComponet.dataset.id].point.push(o),this.activeComponet.setAttribute("d",e)}if("curve"==this.status){let e=this.activeComponet.getAttribute("d"),i={x:t.offsetX,y:t.offsetY};if(e){const s=this.idStore[this.activeComponet.dataset.id].point[this.idStore[this.activeComponet.dataset.id].point.length-1];let n=s.x,a=s.y;i.x1=(t.offsetX-n)/2+n,i.y1=(t.offsetY-a)/2+a,e+=` ${o} ${i.x1} ${i.y1} ${t.offsetX} ${t.offsetY}`,i.type=o}else e=`${s} ${t.offsetX} ${t.offsetY}`,i.type=s;this.idStore[this.activeComponet.dataset.id].point.push(i),this.activeComponet.setAttribute("d",e)}let e=t.target;" svg"==(null==e?void 0:e.nodeName)&&(this.activeComponet=this._ActiveComponet.dataset.line)}}clearLast(){this._ActiveComponet&&this._ActiveComponet.setAttribute("stroke",this._ActiveComponet.dataset.line)}reStart(t){const e=t||this.activeComponet;return e.setAttribute("stroke",this.activeColor),this.status=e.dataset.type,()=>{this.status="none",this._closeFn(),this.activeComponet=this.activeComponet.dataset.line}}getCanvasContext(){return v(this.children)}setCanvasContext(t){var i;let s=document.createElementNS(e,"g"),o=""+Date.now();s.id=o,function(t,i){for(let s=0;s<t.length;s++){const o=t[s];let n=document.createElementNS(e,o.tagName);n.attributes=o.attributes,n.dataset=o.dataset,i.appendChild(n)}}(t,s),null===(i=this.group)||void 0===i||i.appendChild(s)}_addPoint(t){var e,i;const s=t.dataset.id;if(this.idStore[s]&&this.idStore[s].point.length){let t=this.idStore[s].point;this._removePoint();let o=t[0].x==t[t.length-1].x&&t[0].y==t[t.length-1].y;for(let s=0;s<t.length;s++){const n=t[s];let a,d=new p({r:4,x:n.x,y:n.y,fill:this.activeColor},this);n.x1&&n.y1&&(a=new p({r:4,x:n.x1,y:n.y1,fill:this.activeColor},this),a.index=s,a.type="curve",null===(e=this.canvas)||void 0===e||e.appendChild(a.el),this.pointList.push({type:"curve",el:a.el})),o&&0==s||(d.type="point",d.index=s,null===(i=this.canvas)||void 0===i||i.appendChild(d.el),this.pointList.push({type:"point",el:d.el}))}}}_removePoint(){this.pointList&&this.pointList.length&&this.pointList.map((t=>{var e;null===(e=this.canvas)||void 0===e||e.removeChild(t.el)})),this.pointList=[]}setBlank(t){if(t&&(!t.x||!t.y))throw new Error("offset need x and y");this._filterData();let e=[];for(const t in this.idStore)e.push(r(this.idStore[t].point));const i=t||r(e);this.children.map((t=>{const e=this.idStore[t.dataset.id].point,s=l(e,i);t.setAttribute("d",d(s))}))}_filterData(){this.children=this.children.filter((t=>{var e,i,s;return this.idStore[t.dataset.id].point.length||(null===(e=this.canvas)||void 0===e||e.removeChild(t),delete this.idStore[t.dataset.id]),null===(s=null===(i=this.idStore[t.dataset.id])||void 0===i?void 0:i.point)||void 0===s?void 0:s.length}))}_closeFn(){if(this.idStore[this.activeComponet.dataset.id].lineStyle.autoClose&&this.idStore[this.activeComponet.dataset.id].point[0]){const t=this.idStore[this.activeComponet.dataset.id].point[this.idStore[this.activeComponet.dataset.id].point.length-1];let e=this.idStore[this.activeComponet.dataset.id].point,i=(e[0].x-t.x)/2+t.x,s=(e[0].y-t.y)/2+t.y;this.idStore[this.activeComponet.dataset.id].point.push(Object.assign({type:n[this.status],x:e[0].x,y:e[0].y},"curve"==this.status?{x1:i,y1:s}:{})),this.activeComponet.setAttribute("d",d(this.idStore[this.activeComponet.dataset.id].point))}this._filterData(),this.activeComponet=this.activeComponet.dataset.line||"#000"}drawLine(t={}){var e;"line"==this.status&&this._closeFn(),this.status="line",this.clearLast(),this._removePoint();const i=u(t.lineColor||"#000",t.lineWeight||"1",t.fill?t.fill:"transparent");this.activeComponet=i;const s="l"+Date.now();return this.idStore[s]={type:"line",lineStyle:t,point:[]},i.setAttribute("data-id",s),i.setAttribute("data-line",t.lineColor||"#000"),i.setAttribute("data-type","line"),a(i,this),h(i),this.children.push(i),null===(e=this.canvas)||void 0===e||e.appendChild(i),()=>{this._closeFn(),"none"!=this.status&&(this.status="none")}}drawCurve(t={}){var e;"curve"==this.status&&this._closeFn(),this.status="curve",this.clearLast(),this._removePoint();const i=u(t.lineColor||"#000",t.lineWeight||"1",t.fill?t.fill:"transparent");this.activeComponet=i;const s="c"+Date.now();return this.idStore[s]={type:"curve",lineStyle:t,point:[]},i.setAttribute("data-id",s),i.setAttribute("data-line",t.lineColor||"#000"),i.setAttribute("data-type","curve"),a(i,this),h(i),this.children.push(i),null===(e=this.canvas)||void 0===e||e.appendChild(i),()=>{this._closeFn(),"none"!=this.status&&(this.status="none")}}}window&&(window.Drawer=w),t.Drawer=w,Object.defineProperty(t,"__esModule",{value:!0})}));
